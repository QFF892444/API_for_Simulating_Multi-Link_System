<!doctype html><html><head><meta charset="utf-8">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/2.10.0/github-markdown.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/highlight.min.js">
<link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/katex.min.css" integrity="sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y" crossorigin="anonymous">
<link rel="stylesheet" href="https://gitcdn.xyz/repo/goessner/mdmath/master/css/texmath.css">
<link rel="stylesheet" href="https://gitcdn.xyz/repo/goessner/mdmath/master/css/vscode-texmath.css">

</head><body class="markdown-body">
<h1 data-line="NaN" class="code-line" id="report-of-me314-final-project">Report of ME314 Final Project</h1>
<h1 data-line="NaN" class="code-line" id="part-1">Part 1</h1>
<h1 data-line="NaN" class="code-line" id="simulating-multi-link-system">Simulating Multi-link System</h1>
<h2 data-line="NaN" class="code-line" id="feiyu-chen">Feiyu Chen</h2>
<p data-line="NaN" class="code-line">This is the 1st part of my report. I will describe my simulation scene, coordinates of objects, calculation of Euler-Lagrange equations and impacts, etc.</p>
<p data-line="NaN" class="code-line">More details about how I generalized my code for creating multi-link system are put in the Report_part2.pdf.</p>
<h2 data-line="NaN" class="code-line" id="1-proposal">1. Proposal</h2>
<p data-line="NaN" class="code-line">My original proposal was to simulate &quot;a two-link pendulum playing triangular ping-pong against walls&quot; (without user input, just motion and impacts).</p>
<p data-line="NaN" class="code-line">However, as I was doing this project, I found it too troublesome to hardcode all the variables, equations, and impacts. So I wrote an API (several encapsulated functions) for creating links (see <strong>Report_part2.pdf</strong>), and then I simulated a multi-link system with 8 DOF, as seen in the image below.</p>
<p data-line="NaN" class="code-line"><img src="/home/feiyu/Desktop/C2_MachineDynamics/Final3/images/scene_annotated.png" alt="" class="loading" id="image-hash-14d970263bf641f42f3d5290dfc3321ac4b5fdb50460a2d94945ee2cd48fe875"></p>
<center>Figure 1. Simulation scene and annotations.</center>
<h2 data-line="NaN" class="code-line" id="2-figure-of-the-scene">2. Figure of the Scene</h2>
<p data-line="NaN" class="code-line">The above figure shows my simulation scene as well as annotations of the coordinates and transformations.</p>
<p data-line="NaN" class="code-line">There are 5 groups of links in the figure:</p>
<ol>
<li data-line="NaN" class="code-line">A pentagon (DOF=3)</li>
<li data-line="NaN" class="code-line">A 2-link pendulum (DOF=2)</li>
<li data-line="NaN" class="code-line">A 1-link pendulum (DOF=3, height of the left vertex is fixed)</li>
<li data-line="NaN" class="code-line">A 1-link wall (DOF=0)</li>
<li data-line="NaN" class="code-line">Four walls around the main objects (DOF=0)</li>
</ol>
<p data-line="NaN" class="code-line">The x and y axis of each frame are denoted by straight arrows. There are 3 types of frames:</p>
<ul>
<li data-line="NaN" class="code-line"><span style="color:red"> <em>Red frame</em> </span> is for 3-DOF link that has variables <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi mathvariant="bold">x</mi></mrow><annotation encoding="application/x-tex">\mathbf{x}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.44444em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf">x</span></span></span></span></span>, <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi mathvariant="bold">y</mi></mrow><annotation encoding="application/x-tex">\mathbf{y}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.63888em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">y</span></span></span></span></span>, and <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi mathvariant="bold">t</mi><mi mathvariant="bold">h</mi><mi mathvariant="bold">e</mi><mi mathvariant="bold">t</mi><mi mathvariant="bold">a</mi></mrow><annotation encoding="application/x-tex">\mathbf{theta}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf">t</span><span class="mord mathbf">h</span><span class="mord mathbf">e</span><span class="mord mathbf">t</span><span class="mord mathbf">a</span></span></span></span></span>.</li>
<li data-line="NaN" class="code-line"><span style="color:green"> <em>Green frame</em> </span> is for 1-DOF link, which has variable <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi mathvariant="bold">t</mi><mi mathvariant="bold">h</mi><mi mathvariant="bold">e</mi><mi mathvariant="bold">t</mi><mi mathvariant="bold">a</mi></mrow><annotation encoding="application/x-tex">\mathbf{theta}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf">t</span><span class="mord mathbf">h</span><span class="mord mathbf">e</span><span class="mord mathbf">t</span><span class="mord mathbf">a</span></span></span></span></span> and can rotate around a certain pivot.</li>
<li data-line="NaN" class="code-line"><span style="color:gray"> <em>Gray frame</em> </span> is for 0-DOF link, whose two vertices are fixed in a certain frame.</li>
</ul>
<p data-line="NaN" class="code-line">The transformations between different frames are denoted by curved arrows in <span style="color:blue"> blue</span>. These transformations connect up several links to form an object.</p>
<h2 data-line="NaN" class="code-line" id="3-calculation-of-el-eqs-and-impacts">3. Calculation of EL-eqs and Impacts</h2>
<h3 data-line="NaN" class="code-line" id="31-ke-v">3.1 KE-V</h3>
<p data-line="NaN" class="code-line">Suppose a link has length <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi mathvariant="bold">l</mi></mrow><annotation encoding="application/x-tex">\mathbf{l}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf">l</span></span></span></span></span>. Then I assume its mass to be <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi mathvariant="bold">l</mi></mrow><annotation encoding="application/x-tex">\mathbf{l}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf">l</span></span></span></span></span> and inertia to be <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msup><mi mathvariant="bold">l</mi><mn mathvariant="bold">2</mn></msup></mrow><annotation encoding="application/x-tex">\mathbf{l^2}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141079999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord"><span class="mord mathbf">l</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathbf mtight">2</span></span></span></span></span></span></span></span></span></span></span></span>. The generalized 6x6 body mass M is then obtained.</p>
<p data-line="NaN" class="code-line">For each link, I compute the 4x4 matrix representation <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi mathvariant="bold">g</mi></mrow><annotation encoding="application/x-tex">\mathbf{g}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.63888em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">g</span></span></span></span></span> of its center frame. Then calculate the body screw velocity <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi mathvariant="bold">V</mi></mrow><annotation encoding="application/x-tex">\mathbf{V}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68611em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">V</span></span></span></span></span> using <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi mathvariant="bold">g</mi></mrow><annotation encoding="application/x-tex">\mathbf{g}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.63888em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">g</span></span></span></span></span> and <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi mathvariant="bold">d</mi><mi mathvariant="bold">g</mi><mi mathvariant="bold">/</mi><mi mathvariant="bold">d</mi><mi mathvariant="bold">t</mi></mrow><annotation encoding="application/x-tex">\mathbf{dg/dt}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathbf">d</span><span class="mord mathbf" style="margin-right:0.01597em;">g</span><span class="mord mathbf">/</span><span class="mord mathbf">d</span><span class="mord mathbf">t</span></span></span></span></span>. Then the kinetic energy is <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mfrac><mn>1</mn><mn>2</mn></mfrac><mrow><msup><mi mathvariant="bold">V</mi><mi mathvariant="bold">T</mi></msup><mi mathvariant="bold">M</mi><mi mathvariant="bold">V</mi></mrow></mrow><annotation encoding="application/x-tex">\frac{1}{2}\mathbf{V^T M V}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.190108em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.845108em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord"><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">V</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8432769999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathbf mtight">T</span></span></span></span></span></span></span></span><span class="mord mathbf">M</span><span class="mord mathbf" style="margin-right:0.01597em;">V</span></span></span></span></span>.</p>
<h3 data-line="NaN" class="code-line" id="32-constraint-and-external-force">3.2 Constraint and External Force</h3>
<p data-line="NaN" class="code-line">There is no external force in my simulation. But it's easy to add -- simply put something on the right side of EL-eqs.</p>
<p data-line="NaN" class="code-line">I added one constraint to the 1-link pendulum on the right-up side of the figure. I first computed the {x,y} coords of its left vertex, and then set <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi mathvariant="bold">y</mi></mrow><annotation encoding="application/x-tex">\mathbf{y}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.63888em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">y</span></span></span></span></span> as 0. Then I passed it to the EL-eqs.</p>
<h3 data-line="NaN" class="code-line" id="33-detecting-impacts">3.3 Detecting Impacts</h3>
<p data-line="NaN" class="code-line">In my simulation, the impact only happens between a vertex and an edge. An impact happens when:</p>
<ol>
<li data-line="NaN" class="code-line">The vertex has a very small distance to the edge.</li>
<li data-line="NaN" class="code-line">The projection from vertex to edge is on the edge.</li>
</ol>
<p data-line="NaN" class="code-line">I detect the impact by checking these two criteria.</p>
<h3 data-line="NaN" class="code-line" id="34-impact-update">3.4 Impact Update</h3>
<p data-line="NaN" class="code-line">After detecting one or more impacts, my NDSolve breaks up. Then I do the impact updates for all the impacts one by one, get the new <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi mathvariant="bold">d</mi><mi mathvariant="bold">q</mi></mrow><annotation encoding="application/x-tex">\mathbf{dq}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathbf">d</span><span class="mord mathbf">q</span></span></span></span></span>, and call the NDSolve again.</p>
<p data-line="NaN" class="code-line">The logic of my code for impact detection  looks like this:</p>
<pre><code data-line="NaN" class="code-line"><code><div>Loop{
   While(no impact &amp;&amp; t!=t_end{
       NDSolve
   }
   if(impacts){
       impact update for each impact
   }else{
       break
   }
}
</div></code></code></pre>
<h2 data-line="NaN" class="code-line" id="4-result">4. Result</h2>
<h3 data-line="NaN" class="code-line" id="41-how-to-run">4.1 How to run</h3>
<p data-line="NaN" class="code-line">To get the simulation result, please open &quot;run_this.nb&quot; and run its cells one by one.</p>
<p data-line="NaN" class="code-line">The code will open another three &quot;funcs_xxx.nb&quot;, load the functions, and computes the links’ motions. It takes about 3 minutes to compute for 15 seconds simulation.</p>
<p data-line="NaN" class="code-line">The video I recorded is in &quot;scene1.mp4&quot;.</p>
<h3 data-line="NaN" class="code-line" id="42-what-happens-in-simulation">4.2 What happens in simulation</h3>
<p data-line="NaN" class="code-line">In my simulation, the pentagon and 2-link pendulum are moving and sometimes impacting with each other. The 1-link pendulum on the right-up side is just for showing that my &quot;Constraint&quot; is working.</p>
<h3 data-line="NaN" class="code-line" id="43-hamiltonian">4.3 Hamiltonian</h3>
<p data-line="NaN" class="code-line">Since the energy of my system is supposed to be conserved, I plot the Hamiltonian as seen below. It does conserve over time.<br>
<img src="vscode-resource:/home/feiyu/Desktop/C2_MachineDynamics/Final3/images/Halmiltonian.png" alt="" class="loading" id="image-hash-e265e765a77ef24780ffd25e31cffc40f6b92e48404f75d1da604b5a01f70b9f"></p>
<center>Figure 2. Halmiltonian.</center>
<h2 data-line="NaN" class="code-line" id="5-problems">5 Problems</h2>
<h3 data-line="NaN" class="code-line" id="51-fail-to-detect-some-impacts">5.1 Fail to detect some impacts</h3>
<p data-line="NaN" class="code-line">Sometimes, one link will stick into the surface of the polygon.</p>
<p data-line="NaN" class="code-line"><strong>Guess 1:</strong> Need smaller integration step<br>
I tried to use NDSolve's EventLocator's multi-event function, but failed (I couldn't put a list variable there). So I manually code the function of detecting multiple impacts. Its problem is, if I detect an impact at time i, I need to silence it in time i+1, and then it can detect impacts later. Thus, the only case of not detecting impact that I can image is the vertex go through the edge in 2 integration step. (If using EventLocator's multi-event, the special case would be 1 integration step.)</p>
<p data-line="NaN" class="code-line"><strong>Guess 2:</strong> Maybe multi impacts at the same time is also a cause for the problem. But I don't know if there is such logical error in my code.</p>
<p data-line="NaN" class="code-line"><strong>Solution 1:</strong> Decreasing the integral step length (but at a cost of larger computation time).</p>
<p data-line="NaN" class="code-line"><strong>Solution 2:</strong> Use the sign of distance instead of threshold<br>
May be I can solve the problem by detecting the change of sign of the distance to know if a vertex goes through the edge. But its impact criteria would be a little bit more complex than before, and I'm still worrying about the edge cases. I'll try it next time.</p>
<h3 data-line="NaN" class="code-line" id="52-weird-error-about-imaginary-number">5.2 Weird Error about Imaginary Number</h3>
<p data-line="NaN" class="code-line">Occationally I get such an error:</p>
<blockquote data-line="NaN" class="code-line">
<p data-line="NaN" class="code-line">LessEqual::nord: Invalid comparison with -0.977809-1.74032*10^-19 I attempted.</p>
</blockquote>
<p data-line="NaN" class="code-line">I have no idea why my calculation suddenly generates this imaginary number. I tried Re[] and Chop[] to chop out the small imaginary number, but still not thoroughly fix this bug.</p>
<p data-line="NaN" class="code-line">When it happens, what I did is to random the velocity and run another simulation.</p>

</body></html>